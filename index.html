<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç è¿è¡Œæ—¥å¿—è®°å½•å™¨</title>
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ä»£ç ç¼–è¾‘å™¨ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <!-- å¼•å…¥Pyodideï¼ˆå…³é”®ï¼šå¢åŠ åŠ è½½è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼‰ -->
    <script id="pyodide-script" src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">ä»£ç è¿è¡Œæ—¥å¿—è®°å½•å™¨</h1>
        
        <!-- çŠ¶æ€æç¤ºåŒº -->
        <div id="status-area" class="mb-4 p-3 rounded-lg bg-yellow-50 text-yellow-800 text-sm hidden">
            <i class="fa fa-info-circle mr-2"></i><span id="status-message">æ­£åœ¨å‡†å¤‡ç¯å¢ƒ...</span>
        </div>
        
        <!-- æŒ‰é’®åŒºåŸŸ -->
        <div class="flex flex-wrap gap-4 mb-6">
            <button id="show-code-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                æ˜¾ç¤º/éšè—ä»£ç ç¼–è¾‘åŒº
            </button>
            <button id="run-code-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition" disabled>
                è¿è¡Œä»£ç 
            </button>
            <button id="clear-log-btn" class="bg-orange-500 hover:orange-600 text-white px-4 py-2 rounded-lg transition">
                æ¸…ç©ºæ—¥å¿—
            </button>
        </div>
        
        <!-- ä»£ç è¾“å…¥åŒº -->
        <div id="code-input-area" class="hidden mb-6">
            <div class="mb-2 text-sm text-gray-600">
                è¾“å…¥Pythonä»£ç ï¼ˆæ”¯æŒprintè¾“å‡ºï¼‰ï¼š
            </div>
            <textarea id="code-editor" rows="8"></textarea>
        </div>
        
        <!-- è¿è¡Œç»“æœåŒº -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">è¿è¡Œç»“æœ</h2>
            <div id="result-area" class="border border-gray-300 rounded-lg p-3 min-h-[100px] bg-gray-50 font-mono text-sm overflow-auto"></div>
        </div>
        
        <!-- æ—¥å¿—è®°å½•åŒº -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700 mb-2">å†å²æ—¥å¿— <span id="log-count" class="text-sm text-gray-500">(0æ¡è®°å½•)</span></h2>
            <div id="logs-area" class="border border-gray-300 rounded-lg p-3 max-h-[300px] overflow-y-auto bg-gray-50"></div>
        </div>
        
        <!-- å¸®åŠ©æç¤º -->
        <div class="mt-6 text-xs text-gray-500 italic">
            <p>ğŸ’¡ ä½¿ç”¨æç¤ºï¼šå¦‚æœç¯å¢ƒåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢é‡è¯•</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let pyodide;
        let editor;
        let loadAttempts = 0;
        const MAX_LOAD_ATTEMPTS = 3; // æœ€å¤§é‡è¯•æ¬¡æ•°
        
        // æ˜¾ç¤ºçŠ¶æ€æç¤º
        function showStatus(message, isError = false) {
            const statusArea = document.getElementById('status-area');
            const statusMessage = document.getElementById('status-message');
            
            statusArea.classList.remove('hidden', 'bg-yellow-50', 'text-yellow-800', 'bg-red-50', 'text-red-800');
            statusMessage.textContent = message;
            
            if (isError) {
                statusArea.classList.add('bg-red-50', 'text-red-800');
            } else {
                statusArea.classList.add('bg-yellow-50', 'text-yellow-800');
            }
        }
        
        // éšè—çŠ¶æ€æç¤º
        function hideStatus() {
            document.getElementById('status-area').classList.add('hidden');
        }
        
        // åˆå§‹åŒ–Pythonç¯å¢ƒï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        async function initPython() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showStatus("æ­£åœ¨åŠ è½½Pythonç¯å¢ƒï¼Œè¿™å¯èƒ½éœ€è¦1-2åˆ†é’Ÿ...");
            document.getElementById('result-area').textContent = "ç¯å¢ƒåŠ è½½ä¸­ï¼Œè¯·ç¨å€™...";
            
            try {
                // æ£€æŸ¥Pyodideæ˜¯å¦å·²åŠ è½½
                if (typeof loadPyodide === 'undefined') {
                    // ç­‰å¾…è„šæœ¬åŠ è½½å®Œæˆ
                    await new Promise((resolve, reject) => {
                        const script = document.getElementById('pyodide-script');
                        const checkLoaded = () => {
                            if (typeof loadPyodide !== 'undefined') {
                                resolve();
                            } else if (loadAttempts < MAX_LOAD_ATTEMPTS) {
                                loadAttempts++;
                                setTimeout(checkLoaded, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
                            } else {
                                reject(new Error("Pyodideè„šæœ¬åŠ è½½å¤±è´¥"));
                            }
                        };
                        checkLoaded();
                    });
                }
                
                // åŠ è½½Pyodide
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/",
                    fullStdLib: false // å‡å°åŠ è½½ä½“ç§¯ï¼ŒåŠ å¿«é€Ÿåº¦
                });
                
                // åŠ è½½æˆåŠŸ
                document.getElementById('run-code-btn').disabled = false;
                document.getElementById('result-area').textContent = "Pythonç¯å¢ƒå·²å°±ç»ªï¼Œå¯ä»¥è¿è¡Œä»£ç äº†ï¼";
                hideStatus();
                
            } catch (error) {
                // åŠ è½½å¤±è´¥å¤„ç†
                const errorMsg = `ç¯å¢ƒåŠ è½½å¤±è´¥: ${error.message}`;
                document.getElementById('result-area').textContent = errorMsg;
                
                if (loadAttempts < MAX_LOAD_ATTEMPTS) {
                    showStatus(`åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•ï¼ˆ${loadAttempts}/${MAX_LOAD_ATTEMPTS}ï¼‰...`);
                    setTimeout(initPython, 3000); // 3ç§’åé‡è¯•
                } else {
                    showStatus(
                        `å¤šæ¬¡å°è¯•åä»æ— æ³•åŠ è½½ç¯å¢ƒï¼Œè¯·å°è¯•ï¼š1. æ£€æŸ¥ç½‘ç»œè¿æ¥ 2. åˆ·æ–°é¡µé¢ 3. ä½¿ç”¨Chromeæµè§ˆå™¨`, 
                        true
                    );
                }
            }
        }

        // åˆå§‹åŒ–ç¼–è¾‘å™¨
        function initEditor() {
            editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                mode: "python",
                lineNumbers: true,
                theme: "default",
                indentUnit: 4,
                smartIndent: true,
                readOnly: false
            });
            
            // é¢„è®¾ç¤ºä¾‹ä»£ç ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥ä½¿ç”¨
            const exampleCode = `# ç¤ºä¾‹ä»£ç ï¼šè®¡ç®—1åˆ°10çš„å’Œ
total = 0
for i in range(1, 11):
    total += i
print("1åˆ°10çš„å’Œæ˜¯ï¼š", total)

# å°è¯•ä¿®æ”¹ä»£ç ï¼Œç‚¹å‡»"è¿è¡Œä»£ç "æŸ¥çœ‹ç»“æœ`;
            editor.setValue(exampleCode);
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ˜¾ç¤º/éšè—ä»£ç ç¼–è¾‘åŒº
            document.getElementById('show-code-btn').addEventListener('click', () => {
                const area = document.getElementById('code-input-area');
                area.classList.toggle('hidden');
                if (!area.classList.contains('hidden')) {
                    setTimeout(() => editor.focus(), 100);
                }
            });

            // è¿è¡Œä»£ç 
            document.getElementById('run-code-btn').addEventListener('click', async () => {
                const code = editor.getValue().trim();
                if (!code) {
                    document.getElementById('result-area').textContent = "è¯·å…ˆè¾“å…¥ä»£ç ï¼";
                    return;
                }

                try {
                    showStatus("ä»£ç è¿è¡Œä¸­...");
                    let output = "";
                    pyodide.globals.set("print", (text) => {
                        output += text + "\n";
                        document.getElementById('result-area').textContent = output;
                    });
                    
                    await pyodide.runPythonAsync(code);
                    document.getElementById('result-area').textContent = output;
                    
                    // è®°å½•æ—¥å¿—
                    const log = {
                        time: new Date().toLocaleString(),
                        result: output
                    };
                    saveLog(log);
                    renderLogs();
                    hideStatus();

                } catch (error) {
                    const errorMsg = `è¿è¡Œé”™è¯¯ï¼š\n${error.message}`;
                    document.getElementById('result-area').textContent = errorMsg;
                    showStatus("ä»£ç è¿è¡Œå‡ºé”™", true);
                }
            });

            // æ¸…ç©ºæ—¥å¿—
            document.getElementById('clear-log-btn').addEventListener('click', () => {
                if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—è®°å½•å—ï¼Ÿ")) {
                    localStorage.removeItem('codeLogs');
                    logs = [];
                    renderLogs();
                }
            });

            // å®æ—¶ä¿å­˜ä»£ç 
            editor.on('change', saveCodeToLocal);
            window.addEventListener('beforeunload', saveCodeToLocal);
        }

        // æ—¥å¿—ç®¡ç†
        let logs = JSON.parse(localStorage.getItem('codeLogs') || '[]');

        function saveLog(log) {
            logs.unshift(log);
            if (logs.length > 100) logs.pop();
            localStorage.setItem('codeLogs', JSON.stringify(logs));
        }

        function renderLogs() {
            const logCount = document.getElementById('log-count');
            const logsArea = document.getElementById('logs-area');
            
            logCount.textContent = `(${logs.length}æ¡è®°å½•)`;
            
            if (logs.length === 0) {
                logsArea.innerHTML = "<p class='text-gray-500 italic'>æš‚æ— æ—¥å¿—è®°å½•</p>";
                return;
            }

            const totalLogs = logs.length;
            let logsHTML = '';
            
            logs.forEach((log, index) => {
                const logNumber = totalLogs - index;
                logsHTML += `
                <div class="mb-4 p-3 border border-gray-200 rounded-lg bg-white shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium text-gray-800">è®°å½• #${logNumber}</span>
                        <span class="text-xs text-gray-500">${log.time}</span>
                    </div>
                    <div>
                        <span class="text-xs text-gray-600 block mb-1">ç»“æœï¼š</span>
                        <pre class="text-xs bg-gray-50 p-2 rounded overflow-x-auto max-h-20 whitespace-pre-wrap">${escapeHtml(log.result)}</pre>
                    </div>
                </div>
                `;
            });

            logsArea.innerHTML = logsHTML;
        }

        // ä»£ç ä¿å­˜ä¸åŠ è½½
        function saveCodeToLocal() {
            const code = editor.getValue();
            try {
                localStorage.setItem('savedPythonCode', code);
            } catch (e) {
                console.error('ä¿å­˜ä»£ç å¤±è´¥:', e);
            }
        }

        function loadCodeFromLocal() {
            try {
                const savedCode = localStorage.getItem('savedPythonCode');
                if (savedCode && editor) {
                    editor.setValue(savedCode);
                }
            } catch (e) {
                console.error('åŠ è½½ä»£ç å¤±è´¥:', e);
            }
        }

        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // é¡µé¢åˆå§‹åŒ–ï¼ˆä¸¥æ ¼æ§åˆ¶é¡ºåºï¼‰
        window.addEventListener('DOMContentLoaded', () => {
            initEditor();       // 1. å…ˆåˆå§‹åŒ–ç¼–è¾‘å™¨
            loadCodeFromLocal();// 2. åŠ è½½ä¿å­˜çš„ä»£ç 
            bindEvents();       // 3. ç»‘å®šäº‹ä»¶
            initPython();       // 4. æœ€ååˆå§‹åŒ–Pythonç¯å¢ƒ
            renderLogs();       // 5. æ¸²æŸ“æ—¥å¿—
        });
    </script>
</body>
</html>
